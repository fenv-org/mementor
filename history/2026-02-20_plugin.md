# Phase 5: Claude Code Plugin

Parent: [active-agent-pivot](2026-02-20_active-agent-pivot.md)
Depends on: [cli-subcommands](2026-02-20_cli-subcommands.md)

## Background

Phases 1-4 establish the data pipeline and CLI interface. Phase 5 makes these
capabilities available to AI agents via a Claude Code plugin with skills,
agents, and hooks. The plugin replaces the old hook-based settings.json
configuration.

## Goal

Create a Claude Code plugin hosted in the same `fenv-org/mementor` repository.
Update `mementor enable` to migrate from hooks in settings.json to plugin-based
configuration.

## Plugin Directory Structure

```
plugin/
├── .claude-plugin/
│   └── plugin.json
├── skills/
│   ├── recall/SKILL.md
│   ├── sessions/SKILL.md
│   ├── turns/SKILL.md
│   ├── compactions/SKILL.md
│   └── find-related/SKILL.md
├── agents/
│   └── memory-researcher.md
└── hooks/
    └── hooks.json
```

All files live under `plugin/` in the repository root. The marketplace
definition is at the repository root level.

## Plugin Manifest

```json
{
  "name": "mementor",
  "version": "1.0.0",
  "description": "Local RAG memory agent for Claude Code with vector + FTS search",
  "repository": "https://github.com/fenv-org/mementor",
  "skills": ["./skills/"],
  "agents": ["./agents/"],
  "hooks": "./hooks/hooks.json"
}
```

## Marketplace

The marketplace is defined at the repository root:

```
.claude-plugin/
└── marketplace.json
```

```json
{
  "name": "mementor",
  "owner": {
    "name": "fenv-org"
  },
  "plugins": [
    {
      "name": "mementor",
      "source": "./plugin",
      "description": "Local RAG memory agent for Claude Code"
    }
  ]
}
```

Users install via: `/plugin marketplace add fenv-org/mementor` then
`/plugin install mementor@mementor`.

## Skills (5 Total)

### recall (auto-invocable + user-invocable)

```yaml
name: recall
description: >
  Search past conversation memory for relevant context. Use when
  you need historical decisions, previous implementations, or past
  discussions about a topic.
disable-model-invocation: false
user-invocable: true
argument-hint: "[query]"
allowed-tools: "Bash"
```

**Search strategy** (fallback chain in SKILL.md body):

1. `mementor search "<query>" --json` (vector search)
2. If < 3 results → `mementor search "<query>" --fts --json` (keyword)
3. If query mentions a file path → `mementor find-by-file <path> --json`
4. If query mentions a commit hash → `mementor find-by-commit <hash> --json`
5. If query mentions a PR number → `mementor find-by-pr <number> --json`
6. If still insufficient → rephrase with key terms, try other frequently
   used languages in the project's conversations

Skills use `--json` for reliable parsing by the agent.

### sessions (user-invocable only)

```yaml
name: sessions
description: List past Claude Code sessions with metadata.
disable-model-invocation: true
user-invocable: true
argument-hint: "[--pr <number>] [--limit N]"
allowed-tools: "Bash"
```

### turns (user-invocable only)

```yaml
name: turns
description: View turns from a specific session.
disable-model-invocation: true
user-invocable: true
argument-hint: "<session-id> [--limit N]"
allowed-tools: "Bash"
```

### compactions (user-invocable only)

```yaml
name: compactions
description: View compaction summaries from a specific session.
disable-model-invocation: true
user-invocable: true
argument-hint: "<session-id> [--limit N]"
allowed-tools: "Bash"
```

### find-related (auto-invocable + user-invocable)

```yaml
name: find-related
description: >
  Find sessions or turns with similar file access patterns to the
  current session. Use when working on code and you want to find
  past sessions that touched similar files.
disable-model-invocation: false
user-invocable: true
argument-hint: "[sessions|turns]"
allowed-tools: "Bash"
```

Uses `${CLAUDE_SESSION_ID}` for automatic current session detection.

**Graceful degradation**: If the current session has no ingested data yet
(e.g., mid-session before Stop hook fires), return an informative message
rather than an error.

## Memory-Researcher Agent

```yaml
name: memory-researcher
description: >
  Autonomous researcher that searches past conversation memory
  across multiple dimensions. Use when a simple recall search
  isn't sufficient, when the user asks about project history,
  or when you need to understand the evolution of a feature.
tools: "Bash, Read, Glob"
model: "sonnet"
maxTurns: 20
```

**Research strategy** (defined in agent markdown):

1. **Analyze question** -- identify topics, file paths, technical terms
2. **Multi-angle search** (at least 3 angles):
   - Vector search with original query
   - FTS with key technical terms
   - find-by-file for mentioned paths
   - find-related for similar work patterns
   - Rephrase: try synonyms, broader/narrower terms, other frequently
     used languages in the project's conversations
3. **Dig into promising sessions**: compactions → turns get → scoped search
4. **Compile structured findings**: key results, source sessions, timeline,
   confidence level

The agent is auto-invocable (`disable-model-invocation: false`) for deep
multi-step investigation. The recall skill handles quick single-round searches.

## Hooks

```json
{
  "hooks": {
    "Stop": [{
      "matcher": "",
      "hooks": [{
        "type": "command",
        "command": "mementor hook stop"
      }]
    }],
    "PreCompact": [{
      "matcher": "",
      "hooks": [{
        "type": "command",
        "command": "mementor hook pre-compact"
      }]
    }]
  }
}
```

These replace the hooks currently in `.claude/settings.json`. The plugin's
hooks.json is loaded when the plugin is installed.

**Stop hook scope**: entry/turn/chunk/FTS/file_mentions insertion only.
Centroid computation is lazy (triggered by first `find-related` query).

## Installation

`mementor enable` performs a two-file operation:

### `.claude/settings.json` (git-tracked) -- cleanup only

Remove ALL mementor hooks:
- `Stop` (matcher: `""`, command contains `mementor hook stop`)
- `PreCompact` (matcher: `""`, command contains `mementor hook pre-compact`)
- `UserPromptSubmit` (command contains `mementor hook user-prompt-submit`)
- `PreToolUse` (matcher: `Read|Edit|Write|NotebookEdit`, command contains
  `mementor hook pre-tool-use`)
- `SubagentStart` (command contains `mementor hook subagent-start`)

Preserve all non-mementor settings (permissions, attribution, other hooks).
The cleaned settings.json should be committed.

### `.claude/settings.local.json` (gitignored) -- add plugin config

```json
{
  "extraKnownMarketplaces": {
    "mementor": {
      "source": {
        "source": "github",
        "repo": "fenv-org/mementor"
      }
    }
  },
  "enabledPlugins": {
    "mementor@mementor": true
  }
}
```

Merge with existing content (preserve permissions, other plugins like
`"feature-dev@claude-plugins-official"`). Idempotent: re-running doesn't
duplicate entries.

### Post-check

If model is not downloaded, print:
```
Model not found. Run `mementor model download` to download multilingual-e5-base.
```

### Primary worktree guard

`mementor enable` only runs from the primary worktree (existing guard from
PR #24). This prevents conflicting settings across worktrees.

## Worktree Sharing

| Resource | Location | Propagation |
|----------|----------|-------------|
| Plugin config in `settings.local.json` | `.claude/settings.local.json` | `/worktree` skill copies it to new worktrees |
| Plugin cache | `~/.claude/plugins/cache/` | Global, shared automatically |
| Plugin hooks | In cached plugin | Calls `mementor hook stop/pre-compact` which resolve DB via `resolve_worktree()` |

`extraKnownMarketplaces` uses GitHub source (`fenv-org/mementor`), not local
paths. No absolute path issues across worktrees. No changes needed to the
`/worktree` skill or `resolve_worktree()`.

## Files to Create

| File | Content |
|------|---------|
| `plugin/.claude-plugin/plugin.json` | Plugin manifest |
| `plugin/skills/recall/SKILL.md` | Recall skill with fallback chain |
| `plugin/skills/sessions/SKILL.md` | Session listing skill |
| `plugin/skills/turns/SKILL.md` | Turn viewing skill |
| `plugin/skills/compactions/SKILL.md` | Compaction listing skill |
| `plugin/skills/find-related/SKILL.md` | Access pattern search skill |
| `plugin/agents/memory-researcher.md` | Autonomous research agent |
| `plugin/hooks/hooks.json` | Stop + PreCompact hooks |
| `.claude-plugin/marketplace.json` | Marketplace definition (repo root) |

## Files to Modify

| File | Change |
|------|--------|
| `commands/enable.rs` | Rewrite: remove hooks from settings.json, add plugin config to settings.local.json |
| `cli.rs` | Remove `HookCommand::UserPromptSubmit`, `PreToolUse`, `SubagentStart` |
| `hooks/mod.rs` | Remove modules for deleted hooks |
| `CLAUDE.md` | Update plugin installation instructions |

## TODO

- [ ] Create `plugin/.claude-plugin/plugin.json`
- [ ] Write recall SKILL.md with fallback chain
- [ ] Write sessions SKILL.md
- [ ] Write turns SKILL.md
- [ ] Write compactions SKILL.md
- [ ] Write find-related SKILL.md with `${CLAUDE_SESSION_ID}`
- [ ] Write memory-researcher agent markdown
- [ ] Create `plugin/hooks/hooks.json` (Stop + PreCompact)
- [ ] Create `.claude-plugin/marketplace.json` at repo root
- [ ] Rewrite `mementor enable`:
  - [ ] Remove all mementor hooks from settings.json
  - [ ] Add extraKnownMarketplaces + enabledPlugins to settings.local.json
  - [ ] Preserve existing settings content
  - [ ] Add model download check
- [ ] Remove `HookCommand::UserPromptSubmit`, `PreToolUse`, `SubagentStart`
- [ ] Remove `hooks/prompt.rs`, `hooks/pre_tool_use.rs`, `hooks/subagent_start.rs`
- [ ] Remove `hooks/input.rs` structs for deleted hooks
- [ ] Remove `pipeline/query.rs` module
- [ ] Remove dead query functions from `queries.rs`
- [ ] Remove `commands/query.rs`
- [ ] Update CLAUDE.md documentation
- [ ] Integration tests for `mementor enable` (verify settings file changes)
